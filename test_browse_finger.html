<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Fingerprint Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #1f2937;
      background: radial-gradient(circle at top, #1f2937, #020617);
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      flex: 1;
      padding: 16px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      background: linear-gradient(135deg, #22c55e, #38bdf8);
      color: #020617;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9),
                  0 10px 25px rgba(59,130,246,0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }
    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 18px 45px rgba(59,130,246,0.5);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 20px rgba(59,130,246,0.3);
    }
    .hint {
      font-size: 12px;
      color: #9ca3af;
    }
    textarea {
      width: 100%;
      flex: 1;
      min-height: 350px;
      background: #020617;
      color: #e5e7eb;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 14px;
      resize: vertical;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      box-sizing: border-box;
    }
    .footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #111827;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Browser Fingerprint Demo</h1>
    <div class="hint">本页仅在本地浏览器运行，不会发送到任何服务器。用于学习 Fingerprint 采集逻辑。</div>
  </header>

  <main>
    <div class="controls">
      <button id="btnCollect">采集指纹</button>
      <span class="hint">
        提示：若浏览器询问定位/摄像头权限，可选「拒绝」，Demo 依然能运行。
      </span>
    </div>
    <textarea id="output" spellcheck="false" placeholder="点击上面的『采集指纹』按钮后，这里会显示结果 JSON..."></textarea>
    <div class="footer">
      可根据需要对字段进行删减 / 修改。保存为 <code>fingerprint-demo.html</code> 后直接用浏览器打开即可。
    </div>
  </main>

  <script>
    // 简单字符串 hash，用来做 canvas 指纹等
    function simpleHash(str) {
      let h = 0, i, chr;
      if (str.length === 0) return "0";
      for (i = 0; i < str.length; i++) {
        chr = str.charCodeAt(i);
        h = ((h << 5) - h) + chr;
        h |= 0; // 转 32bit int
      }
      return String(h >>> 0);
    }

    function getTimeZone() {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone || null;
      } catch (e) {
        return null;
      }
    }

    function getCanvasFingerprint() {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = 220;
        canvas.height = 60;
        const ctx = canvas.getContext("2d");

        // 背景
        ctx.fillStyle = "#f97316";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 文本
        ctx.textBaseline = "top";
        ctx.font = "16px 'Arial'";
        ctx.fillStyle = "#0ea5e9";
        ctx.fillText("fingerprint_canvas_demo", 4, 10);
        ctx.strokeStyle = "#22c55e";
        ctx.strokeText("fingerprint_canvas_demo", 4, 10);

        const dataURL = canvas.toDataURL();
        return {
          width: canvas.width,
          height: canvas.height,
          hash: simpleHash(dataURL)
        };
      } catch (e) {
        return null;
      }
    }

    function getWebGLFingerprint() {
      try {
        const canvas = document.createElement("canvas");
        const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
        if (!gl) return null;

        const debugInfo = gl.getExtension("WEBGL_debug_renderer_info");
        const vendor = debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : null;
        const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : null;
        const extensions = gl.getSupportedExtensions() || [];

        return {
          vendor,
          renderer,
          version: gl.getParameter(gl.VERSION),
          shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
          extensions
        };
      } catch (e) {
        return null;
      }
    }

    async function getBatteryInfo() {
      try {
        if (!navigator.getBattery) return null;
        const b = await navigator.getBattery();
        return {
          charging: b.charging,
          chargingTime: b.chargingTime,
          dischargingTime: b.dischargingTime,
          level: b.level
        };
      } catch (e) {
        return null;
      }
    }

    async function getMediaDevicesInfo() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
          return null;
        }
        const devices = await navigator.mediaDevices.enumerateDevices();
        return devices.map(d => ({
          kind: d.kind,
          label: d.label,         // 如未授权，一般是空字符串
          deviceId: d.deviceId,   // 若不想暴露，可只保留前几位或 simpleHash
          groupId: d.groupId
        }));
      } catch (e) {
        return null;
      }
    }

    function getNetworkInfo() {
      try {
        const c = navigator.connection ||
                  navigator.mozConnection ||
                  navigator.webkitConnection;
        if (!c) return null;
        return {
          effectiveType: c.effectiveType || null,
          rtt: c.rtt || null,
          downlink: c.downlink || null,
          saveData: c.saveData || false
        };
      } catch (e) {
        return null;
      }
    }

    function getTouchSupport() {
      try {
        const nav = navigator;
        return {
          maxTouchPoints: nav.maxTouchPoints || 0,
          hasTouchEvent: "ontouchstart" in window,
          hasTouchStart: "ontouchstart" in document.documentElement
        };
      } catch (e) {
        return null;
      }
    }

    function getMimeTypes() {
      try {
        const nav = navigator;
        const list = [];
        if (nav.mimeTypes) {
          for (let i = 0; i < nav.mimeTypes.length; i++) {
            const m = nav.mimeTypes[i];
            list.push({
              type: m.type,
              description: m.description,
              suffixes: m.suffixes
            });
          }
        }
        return list;
      } catch (e) {
        return null;
      }
    }

    function getLocation(timeoutMs = 2000) {
      return new Promise(resolve => {
        try {
          if (!navigator.geolocation || typeof navigator.geolocation.getCurrentPosition !== "function") {
            return resolve(null);
          }

          let done = false;
          const timeoutId = setTimeout(() => {
            if (!done) {
              done = true;
              resolve(null);
            }
          }, timeoutMs);

          navigator.geolocation.getCurrentPosition(
            pos => {
              if (done) return;
              done = true;
              clearTimeout(timeoutId);
              const c = pos.coords;
              resolve({
                lat: c.latitude,
                lng: c.longitude,
                accuracy: c.accuracy,
                timestamp: pos.timestamp
              });
            },
            () => {
              if (done) return;
              done = true;
              clearTimeout(timeoutId);
              resolve(null);
            },
            { enableHighAccuracy: false, timeout: timeoutMs, maximumAge: 60000 }
          );
        } catch (e) {
          resolve(null);
        }
      });
    }

    function testStorage(type) {
      try {
        const storage = window[type];
        const key = "__fp_demo__";
        storage.setItem(key, "1");
        storage.removeItem(key);
        return true;
      } catch (e) {
        return false;
      }
    }

    async function collectFingerprint() {
      const nav = navigator || {};
      const scr = screen || {};
      const win = window || {};

      const basic = {
        timestamp: new Date().toISOString(),
        userAgent: nav.userAgent || "",
        platform: nav.platform || "",
        vendor: nav.vendor || "",
        language: nav.language || "",
        languages: Array.isArray(nav.languages) ? nav.languages.slice() : [],
        colorDepth: scr.colorDepth || null,
        screenWidth: scr.width || null,
        screenHeight: scr.height || null,
        availWidth: scr.availWidth || null,
        availHeight: scr.availHeight || null,
        devicePixelRatio: win.devicePixelRatio || 1,
        hardwareConcurrency: nav.hardwareConcurrency || null,
        deviceMemory: nav.deviceMemory || null,
        cookieEnabled: nav.cookieEnabled,
        doNotTrack: nav.doNotTrack || nav.msDoNotTrack || null,
        timezoneOffset: new Date().getTimezoneOffset(),
        timezone: getTimeZone(),
        localStorage: testStorage("localStorage"),
        sessionStorage: testStorage("sessionStorage"),
        pluginsLength: (nav.plugins && nav.plugins.length) || 0,
        cpuClass:nav.cpuClass
      };

      const [
        battery,
        mediaDevices,
        location
      ] = await Promise.all([
        getBatteryInfo(),
        getMediaDevicesInfo(),
        getLocation(2000)
      ]);

      const fp = {
        basic,
        touchSupport: getTouchSupport(),
        canvas: getCanvasFingerprint(),
        webgl: getWebGLFingerprint(),
        battery,
        mediaDevices,
        networkInfo: getNetworkInfo(),
        mimeTypes: getMimeTypes(),
        location
      };

      return fp;
    }

    document.getElementById("btnCollect").addEventListener("click", async () => {
      const output = document.getElementById("output");
      output.value = "采集中，请稍候...\n";
      try {
        const fp = await collectFingerprint();
        output.value = JSON.stringify(fp, null, 2);
      } catch (e) {
        output.value = "采集出错：\n" + (e && e.stack ? e.stack : String(e));
      }
    });
  </script>
</body>
</html>
